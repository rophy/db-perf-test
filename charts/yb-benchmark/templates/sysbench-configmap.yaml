{{- if .Values.sysbench.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "yb-benchmark.fullname" . }}-sysbench-scripts
  labels:
    {{- include "yb-benchmark.labels" . | nindent 4 }}
    app.kubernetes.io/component: sysbench
data:
  sysbench-prepare.sh: |
    #!/bin/bash
    set -e

    # Sysbench prepare script - generated from Helm values
    # Parameters follow YugabyteDB docs: https://docs.yugabyte.com/stable/benchmark/sysbench-ysql/

    echo "=== Sysbench Prepare ==="
    echo "Workload: {{ .Values.sysbench.workload }}"
    echo "Tables: {{ .Values.sysbench.tables | int }} x {{ .Values.sysbench.tableSize | int }} rows"
    echo ""

    exec sysbench {{ .Values.sysbench.workload }} \
      --db-driver=pgsql \
      --pgsql-host={{ .Values.sysbench.db.host }} \
      --pgsql-port={{ .Values.sysbench.db.port | int }} \
      --pgsql-user={{ .Values.sysbench.db.user }} \
      --pgsql-password={{ .Values.sysbench.db.password }} \
      --pgsql-db={{ .Values.sysbench.db.name }} \
      --tables={{ .Values.sysbench.tables | int }} \
      --table_size={{ .Values.sysbench.tableSize | int }} \
      --range_key_partitioning={{ .Values.sysbench.rangeKeyPartitioning }} \
      --serial_cache_size={{ .Values.sysbench.serialCacheSize | int }} \
      --create_secondary={{ .Values.sysbench.createSecondary }} \
      prepare

  sysbench-run.sh: |
    #!/bin/bash
    set -e

    # Sysbench run script - generated from Helm values
    # Parameters follow YugabyteDB docs: https://docs.yugabyte.com/stable/benchmark/sysbench-ysql/

    echo "=== Sysbench Benchmark ==="
    echo "Workload: {{ .Values.sysbench.workload }}"
    echo "Threads: {{ .Values.sysbench.threads | int }}"
    echo "Duration: {{ .Values.sysbench.time | int }}s (warmup: {{ .Values.sysbench.warmupTime | int }}s)"
    echo ""

    # CRITICAL: range_selects=false prevents 100x slowdown from cross-tablet scans
    exec sysbench {{ .Values.sysbench.workload }} \
      --db-driver=pgsql \
      --pgsql-host={{ .Values.sysbench.db.host }} \
      --pgsql-port={{ .Values.sysbench.db.port | int }} \
      --pgsql-user={{ .Values.sysbench.db.user }} \
      --pgsql-password={{ .Values.sysbench.db.password }} \
      --pgsql-db={{ .Values.sysbench.db.name }} \
      --tables={{ .Values.sysbench.tables | int }} \
      --table_size={{ .Values.sysbench.tableSize | int }} \
      --range_key_partitioning={{ .Values.sysbench.rangeKeyPartitioning }} \
      --serial_cache_size={{ .Values.sysbench.serialCacheSize | int }} \
      --create_secondary={{ .Values.sysbench.createSecondary }} \
      --range_selects={{ .Values.sysbench.rangeSelects }} \
      --point_selects={{ .Values.sysbench.pointSelects | int }} \
      --index_updates={{ .Values.sysbench.indexUpdates | int }} \
      --non_index_updates={{ .Values.sysbench.nonIndexUpdates | int }} \
      --num_rows_in_insert={{ .Values.sysbench.numRowsInInsert | int }} \
      --thread-init-timeout={{ .Values.sysbench.threadInitTimeout | int }} \
      --threads={{ .Values.sysbench.threads | int }} \
      --time={{ .Values.sysbench.time | int }} \
      --warmup-time={{ .Values.sysbench.warmupTime | int }} \
      --report-interval={{ .Values.sysbench.reportInterval | int }} \
      run

  sysbench-cleanup.sh: |
    #!/bin/bash
    set -e

    # Sysbench cleanup script - generated from Helm values

    echo "=== Sysbench Cleanup ==="
    echo "Dropping benchmark tables..."
    echo ""

    exec sysbench {{ .Values.sysbench.workload }} \
      --db-driver=pgsql \
      --pgsql-host={{ .Values.sysbench.db.host }} \
      --pgsql-port={{ .Values.sysbench.db.port | int }} \
      --pgsql-user={{ .Values.sysbench.db.user }} \
      --pgsql-password={{ .Values.sysbench.db.password }} \
      --pgsql-db={{ .Values.sysbench.db.name }} \
      --tables={{ .Values.sysbench.tables | int }} \
      --table_size={{ .Values.sysbench.tableSize | int }} \
      cleanup
{{- end }}
