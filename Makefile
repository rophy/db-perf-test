.PHONY: help deploy-aws deploy-minikube clean status ysql
.PHONY: sysbench-prepare sysbench-run sysbench-cleanup sysbench-shell sysbench-logs
.PHONY: report

KUBE_CONTEXT ?= minikube
NAMESPACE ?= yugabyte-test
RELEASE_NAME ?= yb-bench
CHART_DIR := charts/yb-benchmark

KUBECTL := kubectl --context $(KUBE_CONTEXT) -n $(NAMESPACE)
SYSBENCH_POD := deployment/$(RELEASE_NAME)-sysbench

help: ## Show this help
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

# Deployment
deploy-aws: ## Deploy full stack with AWS-optimized settings
	@helm repo add yugabytedb https://charts.yugabyte.com 2>/dev/null || true
	@helm repo update yugabytedb
	@helm dependency build $(CHART_DIR)
	@helm upgrade --install $(RELEASE_NAME) $(CHART_DIR) \
		--kube-context $(KUBE_CONTEXT) \
		--namespace $(NAMESPACE) \
		--create-namespace \
		--set fullnameOverride=$(RELEASE_NAME) \
		-f $(CHART_DIR)/values-aws.yaml \
		--wait --timeout 15m

deploy-minikube: ## Deploy full stack with minikube-optimized settings
	@helm repo add yugabytedb https://charts.yugabyte.com 2>/dev/null || true
	@helm repo update yugabytedb
	@helm dependency build $(CHART_DIR)
	@helm upgrade --install $(RELEASE_NAME) $(CHART_DIR) \
		--kube-context $(KUBE_CONTEXT) \
		--namespace $(NAMESPACE) \
		--create-namespace \
		--set fullnameOverride=$(RELEASE_NAME) \
		-f $(CHART_DIR)/values-minikube.yaml \
		--wait --timeout 15m

deploy-benchmarks: ## Deploy benchmarks only (use existing YugabyteDB)
	@helm upgrade --install $(RELEASE_NAME) $(CHART_DIR) \
		--kube-context $(KUBE_CONTEXT) \
		--namespace $(NAMESPACE) \
		--set yugabyte.enabled=false \
		--set fullnameOverride=$(RELEASE_NAME) \
		--wait --timeout 5m

# Sysbench operations - uses scripts from ConfigMap (parameters in values.yaml)
sysbench-prepare: ## Prepare sysbench tables
	$(KUBECTL) exec $(SYSBENCH_POD) -- /scripts/sysbench-prepare.sh

sysbench-run: ## Run sysbench benchmark
	@KUBE_CONTEXT=$(KUBE_CONTEXT) NAMESPACE=$(NAMESPACE) RELEASE_NAME=$(RELEASE_NAME) \
		./scripts/sysbench-run-with-timestamps.sh

sysbench-cleanup: ## Cleanup sysbench tables
	$(KUBECTL) exec $(SYSBENCH_POD) -- /scripts/sysbench-cleanup.sh

sysbench-shell: ## Open shell in sysbench container
	$(KUBECTL) exec -it $(SYSBENCH_POD) -- /bin/bash

sysbench-logs: ## Show sysbench container logs
	$(KUBECTL) logs -f $(SYSBENCH_POD)

# Report generation
report: ## Generate performance report from last benchmark run
	@KUBE_CONTEXT=$(KUBE_CONTEXT) NAMESPACE=$(NAMESPACE) RELEASE_NAME=$(RELEASE_NAME) ./scripts/report-generator/report.sh

# Utilities
status: ## Show status of all components
	@echo "=== Pods ==="
	@$(KUBECTL) get pods -o wide
	@echo ""
	@echo "=== Services ==="
	@$(KUBECTL) get svc

ysql: ## Connect to YugabyteDB YSQL shell
	$(KUBECTL) exec -it yb-tserver-0 -- /home/yugabyte/bin/ysqlsh -h yb-tserver-service

port-forward-prometheus: ## Port forward Prometheus to localhost:9090
	$(KUBECTL) port-forward svc/$(RELEASE_NAME)-prometheus 9090:9090

# Cleanup
clean: ## Delete all resources
	@echo "Uninstalling $(RELEASE_NAME)..."
	@helm --kube-context $(KUBE_CONTEXT) uninstall $(RELEASE_NAME) -n $(NAMESPACE) 2>/dev/null || true
	@echo "Deleting PVCs..."
	@$(KUBECTL) delete pvc -l app=yb-tserver 2>/dev/null || true
	@$(KUBECTL) delete pvc -l app=yb-master 2>/dev/null || true
	@echo "Deleting namespace..."
	@kubectl --context $(KUBE_CONTEXT) delete namespace $(NAMESPACE) --ignore-not-found
