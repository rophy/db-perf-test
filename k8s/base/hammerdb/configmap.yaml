apiVersion: v1
kind: ConfigMap
metadata:
  name: hammerdb-scripts
  namespace: yugabyte-test
data:
  entrypoint.sh: |
    #!/bin/bash
    set -euo pipefail

    # HammerDB entrypoint script
    # Commands: build, run, delete, shell, web, sleep

    COMMAND="${1:-sleep}"
    HAMMERDB_HOME="${HAMMERDB_HOME:-/home/hammerdb}"

    case "$COMMAND" in
        build)
            echo "=== Building TPROC-C Schema ==="
            cd "$HAMMERDB_HOME"
            ./hammerdbcli auto /scripts/buildschema.tcl
            ;;
        run)
            echo "=== Running TPROC-C Workload ==="
            cd "$HAMMERDB_HOME"
            ./hammerdbcli auto /scripts/runworkload.tcl
            ;;
        delete)
            echo "=== Deleting TPROC-C Schema ==="
            cd "$HAMMERDB_HOME"
            ./hammerdbcli auto /scripts/deleteschema.tcl
            ;;
        shell)
            echo "=== Starting HammerDB CLI Shell ==="
            cd "$HAMMERDB_HOME"
            exec ./hammerdbcli
            ;;
        web)
            echo "=== Starting HammerDB Web Service ==="
            cd "$HAMMERDB_HOME"
            exec ./hammerdbws
            ;;
        sleep)
            echo "=== HammerDB container ready ==="
            echo "Use 'kubectl exec' to run commands:"
            echo "  kubectl exec -it <pod> -- /scripts/entrypoint.sh build"
            echo "  kubectl exec -it <pod> -- /scripts/entrypoint.sh run"
            echo "  kubectl exec -it <pod> -- /scripts/entrypoint.sh delete"
            echo "  kubectl exec -it <pod> -- /scripts/entrypoint.sh shell"
            exec sleep infinity
            ;;
        *)
            echo "Unknown command: $COMMAND"
            echo "Usage: entrypoint.sh [build|run|delete|shell|web|sleep]"
            exit 1
            ;;
    esac

  buildschema.tcl: |
    #!/usr/bin/tclsh
    # HammerDB TPROC-C Schema Build Script for PostgreSQL/YugabyteDB

    puts "=== HammerDB TPROC-C Schema Build ==="

    # Database configuration
    dbset db pg
    dbset bm TPC-C

    # Connection settings from environment variables
    set pg_host [expr {[info exists ::env(PG_HOST)] ? $::env(PG_HOST) : "yb-tserver-service"}]
    set pg_port [expr {[info exists ::env(PG_PORT)] ? $::env(PG_PORT) : "5433"}]
    set pg_superuser [expr {[info exists ::env(PG_SUPERUSER)] ? $::env(PG_SUPERUSER) : "yugabyte"}]
    set pg_superpass [expr {[info exists ::env(PG_SUPERPASS)] ? $::env(PG_SUPERPASS) : "yugabyte"}]
    set pg_defaultdbase [expr {[info exists ::env(PG_DEFAULTDBASE)] ? $::env(PG_DEFAULTDBASE) : "yugabyte"}]
    set pg_user [expr {[info exists ::env(PG_USER)] ? $::env(PG_USER) : "tpcc"}]
    set pg_pass [expr {[info exists ::env(PG_PASS)] ? $::env(PG_PASS) : "tpcc"}]
    set pg_dbase [expr {[info exists ::env(PG_DBASE)] ? $::env(PG_DBASE) : "tpcc"}]
    set warehouses [expr {[info exists ::env(HAMMERDB_WAREHOUSES)] ? $::env(HAMMERDB_WAREHOUSES) : "4"}]
    set vus [expr {[info exists ::env(HAMMERDB_VUS)] ? $::env(HAMMERDB_VUS) : "4"}]

    puts "Configuration:"
    puts "  Host: $pg_host:$pg_port"
    puts "  Superuser: $pg_superuser"
    puts "  Database: $pg_dbase"
    puts "  Warehouses: $warehouses"
    puts "  Virtual Users: $vus"

    # PostgreSQL connection settings
    diset connection pg_host $pg_host
    diset connection pg_port $pg_port

    # TPROC-C schema settings
    diset tpcc pg_count_ware $warehouses
    diset tpcc pg_num_vu $vus
    diset tpcc pg_superuser $pg_superuser
    diset tpcc pg_superuserpass $pg_superpass
    diset tpcc pg_defaultdbase $pg_defaultdbase
    diset tpcc pg_user $pg_user
    diset tpcc pg_pass $pg_pass
    diset tpcc pg_dbase $pg_dbase

    # Build schema
    puts "\nBuilding schema..."
    buildschema

    puts "\n=== Schema Build Complete ==="

  runworkload.tcl: |
    #!/usr/bin/tclsh
    # HammerDB TPROC-C Workload Script for PostgreSQL/YugabyteDB

    puts "=== HammerDB TPROC-C Workload ==="

    # Database configuration
    dbset db pg
    dbset bm TPC-C

    # Connection settings from environment variables
    set pg_host [expr {[info exists ::env(PG_HOST)] ? $::env(PG_HOST) : "yb-tserver-service"}]
    set pg_port [expr {[info exists ::env(PG_PORT)] ? $::env(PG_PORT) : "5433"}]
    set pg_user [expr {[info exists ::env(PG_USER)] ? $::env(PG_USER) : "tpcc"}]
    set pg_pass [expr {[info exists ::env(PG_PASS)] ? $::env(PG_PASS) : "tpcc"}]
    set pg_dbase [expr {[info exists ::env(PG_DBASE)] ? $::env(PG_DBASE) : "tpcc"}]
    set vus [expr {[info exists ::env(HAMMERDB_VUS)] ? $::env(HAMMERDB_VUS) : "4"}]
    set duration [expr {[info exists ::env(HAMMERDB_DURATION)] ? $::env(HAMMERDB_DURATION) : "5"}]
    set rampup [expr {[info exists ::env(HAMMERDB_RAMPUP)] ? $::env(HAMMERDB_RAMPUP) : "1"}]

    puts "Configuration:"
    puts "  Host: $pg_host:$pg_port"
    puts "  Database: $pg_dbase"
    puts "  User: $pg_user"
    puts "  Virtual Users: $vus"
    puts "  Duration: $duration minutes"
    puts "  Rampup: $rampup minutes"

    # PostgreSQL connection settings
    diset connection pg_host $pg_host
    diset connection pg_port $pg_port

    # TPROC-C driver settings
    diset tpcc pg_driver timed
    diset tpcc pg_rampup $rampup
    diset tpcc pg_duration $duration
    diset tpcc pg_user $pg_user
    diset tpcc pg_pass $pg_pass
    diset tpcc pg_dbase $pg_dbase

    # Enable all transaction types
    diset tpcc pg_allwarehouse false
    diset tpcc pg_timeprofile false

    # Load driver script
    loadscript

    puts "\nStarting virtual users..."
    vuset vu $vus
    vucreate
    vurun

    puts "\n=== Workload started - waiting for completion ==="
    # Wait for virtual users to finish
    runtimer [expr {($rampup + $duration + 1) * 60}]

    puts "\n=== Workload Complete ==="
    vudestroy

  deleteschema.tcl: |
    #!/usr/bin/tclsh
    # HammerDB TPROC-C Schema Delete Script for PostgreSQL/YugabyteDB

    puts "=== HammerDB TPROC-C Schema Delete ==="

    # Database configuration
    dbset db pg
    dbset bm TPC-C

    # Connection settings from environment variables
    set pg_host [expr {[info exists ::env(PG_HOST)] ? $::env(PG_HOST) : "yb-tserver-service"}]
    set pg_port [expr {[info exists ::env(PG_PORT)] ? $::env(PG_PORT) : "5433"}]
    set pg_superuser [expr {[info exists ::env(PG_SUPERUSER)] ? $::env(PG_SUPERUSER) : "yugabyte"}]
    set pg_superpass [expr {[info exists ::env(PG_SUPERPASS)] ? $::env(PG_SUPERPASS) : "yugabyte"}]
    set pg_defaultdbase [expr {[info exists ::env(PG_DEFAULTDBASE)] ? $::env(PG_DEFAULTDBASE) : "yugabyte"}]
    set pg_user [expr {[info exists ::env(PG_USER)] ? $::env(PG_USER) : "tpcc"}]
    set pg_dbase [expr {[info exists ::env(PG_DBASE)] ? $::env(PG_DBASE) : "tpcc"}]

    puts "Configuration:"
    puts "  Host: $pg_host:$pg_port"
    puts "  Superuser: $pg_superuser"
    puts "  Database to delete: $pg_dbase"
    puts "  User to delete: $pg_user"

    # PostgreSQL connection settings
    diset connection pg_host $pg_host
    diset connection pg_port $pg_port

    # TPROC-C settings for deletion
    diset tpcc pg_superuser $pg_superuser
    diset tpcc pg_superuserpass $pg_superpass
    diset tpcc pg_defaultdbase $pg_defaultdbase
    diset tpcc pg_user $pg_user
    diset tpcc pg_dbase $pg_dbase

    # Delete schema
    puts "\nDeleting schema..."
    deleteschema

    puts "\n=== Schema Delete Complete ==="
