# Sysbench deployment for YugabyteDB benchmarking
# Parameters match YugabyteDB official docs: https://docs.yugabyte.com/stable/benchmark/sysbench-ysql/
apiVersion: v1
kind: ConfigMap
metadata:
  name: sysbench-scripts
  namespace: yugabyte-test
data:
  entrypoint.sh: |
    #!/bin/bash
    set -e

    # Sysbench entrypoint script for YugabyteDB benchmarking
    # All parameters from: https://docs.yugabyte.com/stable/benchmark/sysbench-ysql/

    # Database connection
    : "${PG_HOST:=yb-tserver-service}"
    : "${PG_PORT:=5433}"
    : "${PG_USER:=yugabyte}"
    : "${PG_PASS:=yugabyte}"
    : "${PG_DB:=yugabyte}"

    # Benchmark scale (from YugabyteDB docs)
    : "${SYSBENCH_TABLES:=20}"
    : "${SYSBENCH_TABLE_SIZE:=5000000}"
    : "${SYSBENCH_THREADS:=60}"
    : "${SYSBENCH_TIME:=1800}"
    : "${SYSBENCH_WARMUP:=300}"
    : "${SYSBENCH_WORKLOAD:=oltp_read_write}"

    # YugabyteDB prepare options (from docs)
    : "${SYSBENCH_RANGE_KEY_PARTITIONING:=false}"
    : "${SYSBENCH_SERIAL_CACHE_SIZE:=1000}"
    : "${SYSBENCH_CREATE_SECONDARY:=true}"

    # YugabyteDB run options (from docs)
    : "${SYSBENCH_RANGE_SELECTS:=false}"
    : "${SYSBENCH_POINT_SELECTS:=10}"
    : "${SYSBENCH_INDEX_UPDATES:=10}"
    : "${SYSBENCH_NON_INDEX_UPDATES:=10}"
    : "${SYSBENCH_NUM_ROWS_IN_INSERT:=10}"
    : "${SYSBENCH_THREAD_INIT_TIMEOUT:=90}"

    # Build prepare options
    build_prepare_opts() {
        echo "--db-driver=pgsql \
    --pgsql-host=${PG_HOST} \
    --pgsql-port=${PG_PORT} \
    --pgsql-user=${PG_USER} \
    --pgsql-password=${PG_PASS} \
    --pgsql-db=${PG_DB} \
    --tables=${SYSBENCH_TABLES} \
    --table_size=${SYSBENCH_TABLE_SIZE} \
    --range_key_partitioning=${SYSBENCH_RANGE_KEY_PARTITIONING} \
    --serial_cache_size=${SYSBENCH_SERIAL_CACHE_SIZE} \
    --create_secondary=${SYSBENCH_CREATE_SECONDARY}"
    }

    # Build run options
    build_run_opts() {
        echo "$(build_prepare_opts) \
    --threads=${SYSBENCH_THREADS} \
    --time=${SYSBENCH_TIME} \
    --warmup-time=${SYSBENCH_WARMUP} \
    --report-interval=10 \
    --range_selects=${SYSBENCH_RANGE_SELECTS} \
    --point_selects=${SYSBENCH_POINT_SELECTS} \
    --index_updates=${SYSBENCH_INDEX_UPDATES} \
    --non_index_updates=${SYSBENCH_NON_INDEX_UPDATES} \
    --num_rows_in_insert=${SYSBENCH_NUM_ROWS_IN_INSERT} \
    --thread-init-timeout=${SYSBENCH_THREAD_INIT_TIMEOUT}"
    }

    do_prepare() {
        echo "=== Sysbench Prepare ==="
        echo "Host: ${PG_HOST}:${PG_PORT}"
        echo "Tables: ${SYSBENCH_TABLES}, Size: ${SYSBENCH_TABLE_SIZE}"
        echo ""
        local opts=$(build_prepare_opts)
        echo "Command: sysbench ${SYSBENCH_WORKLOAD} ${opts} prepare"
        echo ""
        sysbench ${SYSBENCH_WORKLOAD} ${opts} prepare
        echo "=== Prepare Complete ==="
    }

    do_run() {
        echo "=== Sysbench Run ==="
        echo "Host: ${PG_HOST}:${PG_PORT}"
        echo "Workload: ${SYSBENCH_WORKLOAD}"
        echo "Threads: ${SYSBENCH_THREADS}, Time: ${SYSBENCH_TIME}s, Warmup: ${SYSBENCH_WARMUP}s"
        echo ""
        local opts=$(build_run_opts)
        echo "Command: sysbench ${SYSBENCH_WORKLOAD} ${opts} run"
        echo ""
        sysbench ${SYSBENCH_WORKLOAD} ${opts} run
        echo "=== Run Complete ==="
    }

    do_cleanup() {
        echo "=== Sysbench Cleanup ==="
        local opts=$(build_prepare_opts)
        sysbench ${SYSBENCH_WORKLOAD} ${opts} cleanup
        echo "=== Cleanup Complete ==="
    }

    do_config() {
        echo "=== Sysbench Configuration ==="
        echo ""
        echo "Database:"
        echo "  PG_HOST=${PG_HOST}"
        echo "  PG_PORT=${PG_PORT}"
        echo "  PG_USER=${PG_USER}"
        echo "  PG_DB=${PG_DB}"
        echo ""
        echo "Scale:"
        echo "  SYSBENCH_TABLES=${SYSBENCH_TABLES}"
        echo "  SYSBENCH_TABLE_SIZE=${SYSBENCH_TABLE_SIZE}"
        echo "  SYSBENCH_THREADS=${SYSBENCH_THREADS}"
        echo "  SYSBENCH_TIME=${SYSBENCH_TIME}"
        echo "  SYSBENCH_WARMUP=${SYSBENCH_WARMUP}"
        echo "  SYSBENCH_WORKLOAD=${SYSBENCH_WORKLOAD}"
        echo ""
        echo "YugabyteDB Prepare Options:"
        echo "  SYSBENCH_RANGE_KEY_PARTITIONING=${SYSBENCH_RANGE_KEY_PARTITIONING}"
        echo "  SYSBENCH_SERIAL_CACHE_SIZE=${SYSBENCH_SERIAL_CACHE_SIZE}"
        echo "  SYSBENCH_CREATE_SECONDARY=${SYSBENCH_CREATE_SECONDARY}"
        echo ""
        echo "YugabyteDB Run Options:"
        echo "  SYSBENCH_RANGE_SELECTS=${SYSBENCH_RANGE_SELECTS}"
        echo "  SYSBENCH_POINT_SELECTS=${SYSBENCH_POINT_SELECTS}"
        echo "  SYSBENCH_INDEX_UPDATES=${SYSBENCH_INDEX_UPDATES}"
        echo "  SYSBENCH_NON_INDEX_UPDATES=${SYSBENCH_NON_INDEX_UPDATES}"
        echo "  SYSBENCH_NUM_ROWS_IN_INSERT=${SYSBENCH_NUM_ROWS_IN_INSERT}"
        echo "  SYSBENCH_THREAD_INIT_TIMEOUT=${SYSBENCH_THREAD_INIT_TIMEOUT}"
    }

    case "${1:-sleep}" in
        prepare) do_prepare ;;
        run) do_run ;;
        cleanup) do_cleanup ;;
        config) do_config ;;
        shell) exec /bin/bash ;;
        sleep)
            echo "Sysbench ready."
            do_config
            exec sleep infinity
            ;;
        *) echo "Usage: $0 {prepare|run|cleanup|config|shell|sleep}"; exit 1 ;;
    esac
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sysbench
  namespace: yugabyte-test
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sysbench
  template:
    metadata:
      labels:
        app: sysbench
    spec:
      containers:
      - name: sysbench
        image: rophy/sysbench:yugabyte-20260119
        imagePullPolicy: IfNotPresent
        command: ["/bin/bash", "/scripts/entrypoint.sh", "sleep"]
        env:
        # Database connection
        - name: PG_HOST
          value: "yb-tserver-service"
        - name: PG_PORT
          value: "5433"
        - name: PG_USER
          value: "yugabyte"
        - name: PG_PASS
          value: "yugabyte"
        - name: PG_DB
          value: "yugabyte"
        # Benchmark scale (per YugabyteDB docs)
        - name: SYSBENCH_TABLES
          value: "20"
        - name: SYSBENCH_TABLE_SIZE
          value: "5000000"
        - name: SYSBENCH_THREADS
          value: "60"
        - name: SYSBENCH_TIME
          value: "1800"
        - name: SYSBENCH_WARMUP
          value: "300"
        - name: SYSBENCH_WORKLOAD
          value: "oltp_read_write"
        # YugabyteDB prepare options (per docs)
        - name: SYSBENCH_RANGE_KEY_PARTITIONING
          value: "false"
        - name: SYSBENCH_SERIAL_CACHE_SIZE
          value: "1000"
        - name: SYSBENCH_CREATE_SECONDARY
          value: "true"
        # YugabyteDB run options (per docs)
        - name: SYSBENCH_RANGE_SELECTS
          value: "false"
        - name: SYSBENCH_POINT_SELECTS
          value: "10"
        - name: SYSBENCH_INDEX_UPDATES
          value: "10"
        - name: SYSBENCH_NON_INDEX_UPDATES
          value: "10"
        - name: SYSBENCH_NUM_ROWS_IN_INSERT
          value: "10"
        - name: SYSBENCH_THREAD_INIT_TIMEOUT
          value: "90"
        resources:
          requests:
            cpu: "500m"
            memory: "1Gi"
          limits:
            cpu: "2"
            memory: "2Gi"
        volumeMounts:
        - name: scripts
          mountPath: /scripts
      volumes:
      - name: scripts
        configMap:
          name: sysbench-scripts
          defaultMode: 0755
