---
# Source: yb-benchmark/templates/sysbench-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: release-name-yb-benchmark-sysbench-scripts
  labels:
    helm.sh/chart: yb-benchmark-0.1.0
    app.kubernetes.io/name: yb-benchmark
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: sysbench
data:
  sysbench-prepare.sh: |
    #!/bin/bash
    set -e

    # Sysbench prepare script - generated from Helm values
    # Parameters follow YugabyteDB docs: https://docs.yugabyte.com/stable/benchmark/sysbench-ysql/

    WORKLOAD="oltp_read_write"

    # Database connection flags
    DB_OPTS=(
      --db-driver=pgsql
      --pgsql-host=yb-tserver-service
      --pgsql-port=5433
      --pgsql-user=yugabyte
      --pgsql-password=yugabyte
      --pgsql-db=yugabyte
      --tables=20
      --table_size=5e+06
    )

    # YugabyteDB-specific prepare flags
    YB_OPTS=(
      --range_key_partitioning=false
      --serial_cache_size=1000
      --create_secondary=true
    )

    echo "=== Sysbench Prepare ==="
    echo "Workload: ${WORKLOAD}"
    echo "Tables: 20 x 5e+06 rows"
    echo ""

    exec sysbench "${WORKLOAD}" "${DB_OPTS[@]}" "${YB_OPTS[@]}" prepare

  sysbench-run.sh: |
    #!/bin/bash
    set -e

    # Sysbench run script - generated from Helm values
    # Parameters follow YugabyteDB docs: https://docs.yugabyte.com/stable/benchmark/sysbench-ysql/

    WORKLOAD="oltp_read_write"

    # Database connection flags
    DB_OPTS=(
      --db-driver=pgsql
      --pgsql-host=yb-tserver-service
      --pgsql-port=5433
      --pgsql-user=yugabyte
      --pgsql-password=yugabyte
      --pgsql-db=yugabyte
      --tables=20
      --table_size=5e+06
    )

    # YugabyteDB-specific and workload tuning flags
    # CRITICAL: range_selects=false prevents 100x slowdown from cross-tablet scans
    YB_OPTS=(
      --range_key_partitioning=false
      --serial_cache_size=1000
      --create_secondary=true
      --range_selects=false
      --point_selects=10
      --index_updates=10
      --non_index_updates=10
      --num_rows_in_insert=10
      --thread-init-timeout=90
    )

    # Run parameters
    RUN_OPTS=(
      --threads=60
      --time=1800
      --warmup-time=300
      --report-interval=10
    )

    echo "=== Sysbench Benchmark ==="
    echo "Workload: ${WORKLOAD}"
    echo "Threads: 60"
    echo "Duration: 1800s (warmup: 300s)"
    echo ""

    exec sysbench "${WORKLOAD}" "${DB_OPTS[@]}" "${YB_OPTS[@]}" "${RUN_OPTS[@]}" run

  sysbench-cleanup.sh: |
    #!/bin/bash
    set -e

    # Sysbench cleanup script - generated from Helm values

    WORKLOAD="oltp_read_write"

    # Database connection flags
    DB_OPTS=(
      --db-driver=pgsql
      --pgsql-host=yb-tserver-service
      --pgsql-port=5433
      --pgsql-user=yugabyte
      --pgsql-password=yugabyte
      --pgsql-db=yugabyte
      --tables=20
      --table_size=5e+06
    )

    echo "=== Sysbench Cleanup ==="
    echo "Dropping benchmark tables..."
    echo ""

    exec sysbench "${WORKLOAD}" "${DB_OPTS[@]}" cleanup
